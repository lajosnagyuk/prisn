---
# Example 1: App with shared RWX storage
# All replicas share the same /data directory
# Requires a storage class that supports ReadWriteMany (e.g., NFS, AzureFile, EFS)
apiVersion: prisn.io/v1alpha1
kind: PrisnApp
metadata:
  name: shared-data-app
spec:
  runtime: python3
  replicas: 3
  port: 8080
  source:
    inline: |
      from http.server import HTTPServer, BaseHTTPRequestHandler
      import json
      import os
      from pathlib import Path

      DATA_DIR = Path("/data")

      class Handler(BaseHTTPRequestHandler):
          def do_GET(self):
              if self.path == '/health':
                  self.send_response(200)
                  self.end_headers()
                  self.wfile.write(b'{"status": "healthy"}')
              elif self.path == '/files':
                  # List all files in shared storage
                  files = list(DATA_DIR.glob('*'))
                  self.send_response(200)
                  self.send_header('Content-Type', 'application/json')
                  self.end_headers()
                  self.wfile.write(json.dumps({
                      "hostname": os.environ.get('HOSTNAME', 'unknown'),
                      "files": [str(f.name) for f in files]
                  }).encode())
              else:
                  self.send_response(200)
                  self.end_headers()
                  self.wfile.write(f"Hello from {os.environ.get('HOSTNAME')}".encode())

          def do_POST(self):
              if self.path.startswith('/files/'):
                  # Write a file to shared storage
                  filename = self.path.split('/')[-1]
                  content_length = int(self.headers.get('Content-Length', 0))
                  body = self.rfile.read(content_length)
                  (DATA_DIR / filename).write_bytes(body)
                  self.send_response(201)
                  self.end_headers()
                  self.wfile.write(json.dumps({
                      "written_by": os.environ.get('HOSTNAME'),
                      "file": filename
                  }).encode())

      if __name__ == '__main__':
          DATA_DIR.mkdir(exist_ok=True)
          server = HTTPServer(('0.0.0.0', 8080), Handler)
          print(f"Starting server, data dir: {DATA_DIR}")
          server.serve_forever()
    entrypoint: script
  healthCheck:
    path: /health
  storage:
    - name: data
      mountPath: /data
      size: 5Gi
      accessMode: ReadWriteMany
      storageClassName: azurefile  # Change to your RWX storage class
  resources:
    cpu: "100m"
    memory: "128Mi"

---
# Example 2: Using an existing PVC
apiVersion: prisn.io/v1alpha1
kind: PrisnApp
metadata:
  name: use-existing-pvc
spec:
  runtime: python3
  replicas: 2
  source:
    inline: |
      import os
      import time
      while True:
          files = os.listdir('/shared')
          print(f"Files in /shared: {files}")
          time.sleep(10)
    entrypoint: script
  storage:
    - name: shared
      mountPath: /shared
      existingClaim: my-existing-pvc  # Must exist before creating the PrisnApp

---
# Example 3: Multiple storage volumes with different purposes
apiVersion: prisn.io/v1alpha1
kind: PrisnApp
metadata:
  name: multi-volume-app
spec:
  runtime: python3
  replicas: 2
  source:
    inline: |
      import os
      print(f"Cache dir contents: {os.listdir('/cache')}")
      print(f"Data dir contents: {os.listdir('/data')}")
      print(f"Logs dir contents: {os.listdir('/logs')}")
      # Your app logic here
      import time
      while True:
          time.sleep(60)
    entrypoint: script
  storage:
    # Fast cache (could use SSD-backed storage class)
    - name: cache
      mountPath: /cache
      size: 1Gi
      accessMode: ReadWriteMany
      storageClassName: fast-rwx

    # Main data storage
    - name: data
      mountPath: /data
      size: 10Gi
      accessMode: ReadWriteMany
      storageClassName: standard-rwx

    # Logs storage (read-only after initial write)
    - name: logs
      mountPath: /logs
      size: 2Gi
      accessMode: ReadWriteMany
      storageClassName: standard-rwx

---
# Example 4: SubPath usage - multiple apps sharing one PVC
# First, create a shared PVC manually:
# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#   name: shared-workspace
# spec:
#   accessModes: [ReadWriteMany]
#   resources:
#     requests:
#       storage: 20Gi
#   storageClassName: azurefile

apiVersion: prisn.io/v1alpha1
kind: PrisnApp
metadata:
  name: app-a
spec:
  runtime: python3
  replicas: 1
  source:
    inline: |
      import os
      # This app only sees /workspace, which maps to /app-a on the PVC
      print(f"My workspace: {os.listdir('/workspace')}")
      import time
      while True:
          time.sleep(60)
    entrypoint: script
  storage:
    - name: workspace
      mountPath: /workspace
      existingClaim: shared-workspace
      subPath: app-a  # Isolates this app to /app-a directory on the PVC
---
apiVersion: prisn.io/v1alpha1
kind: PrisnApp
metadata:
  name: app-b
spec:
  runtime: python3
  replicas: 1
  source:
    inline: |
      import os
      # This app only sees /workspace, which maps to /app-b on the PVC
      print(f"My workspace: {os.listdir('/workspace')}")
      import time
      while True:
          time.sleep(60)
    entrypoint: script
  storage:
    - name: workspace
      mountPath: /workspace
      existingClaim: shared-workspace
      subPath: app-b  # Isolates this app to /app-b directory on the PVC
